<?xml version="1.0"  encoding="UTF-8" ?>

<project name="live-setup" basedir="." default="live">
    <property file="build-scripts/live-setup/build.properties" />
    <property file="configurations/live-server/build.properties" />

    <!-- ============================================  -->
    <!-- Target: live                       		   -->
    <!-- ============================================  -->
    <target name="live" description="adjust settings for live deployment">
    	<exec command="rm -rf `find . -name .svn`" dir="." />
        <copy file="${shop.local.xml.file}" todir="shop/app/etc" />
        <copy file="${api.configuration.file}" todir="motivado-api" />
        <copy file="${importer.configuration.file}" todir="coaching-import" />
		<echo>Importing Coachings...</echo>
        <exec command="php coaching-import/cli/import.php" checkreturn="true" />
		<echo>Importing Coachings... done.</echo>
        <delete dir="coaching-import" includeemptydirs="true" failonerror="true" />
        <delete dir="modeling" includeemptydirs="true" failonerror="true" />
        <delete dir="build-scripts" includeemptydirs="true" failonerror="true" />
        <delete dir="configurations" includeemptydirs="true" failonerror="true" />
        <tar destfile="phing.tar" basedir="." compression="gzip"/>
        <scp username="${server.username}" 
        	 password="${server.password}"
        	 host="${server.host}" 
        	 todir="${server.path.next}"
        	 autocreate="true"
        	 file="phing.tar" />
        <ssh username="${server.username}" 
        	 password="${server.password}"
        	 host="${server.host}" 
        	 command="tar -C ${server.path.next} -xf ${server.path.next}/phing.tar" />
		<ssh username="${server.username}" 
                 password="${server.password}"
                 host="${server.host}" 
                 command="rm ${server.path.next}/phing.tar" />
        <echo>Switching Website...</echo>
        <ssh username="${server.username}" 
                 password="${server.password}"
                 host="${server.host}" 
                 command="mv ${server.path.current} ${server.old.prefix}`date +%m%d%y_%M%S`" />
        <ssh username="${server.username}" 
                 password="${server.password}"
                 host="${server.host}" 
                 command="mv ${server.path.next} ${server.path.current}" />
		<echo>Switching Website... done.</echo>                 
        <!-- KILL SESSIONS -->
        <echo>BUILD SUCCESS</echo>
    </target>
    
</project>
