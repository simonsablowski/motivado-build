<?xml version="1.0"  encoding="UTF-8" ?>

<project name="live-setup" basedir="." default="live">
    <property file="build-scripts/live-setup/build.properties" />
    <property file="configurations/live-server/build.properties" />

    <!-- Fileset for all files -->
    <fileset dir="./" id="allfiles">
        <include name="**" />
    </fileset>
    
    <!-- ============================================  -->
    <!-- Target: svnexport	                           -->
    <!-- ============================================  -->
    <target name="svnexport" description="checks out the required sources from SVN">
		<svnexport
			svnpath="${svn.path}"
			force="true"
			nocache="true"
			ignoreexternals="false"
			repositoryurl="${svn.url}"
			todir="${buildDir}"
		/>
    </target>
    
    <!-- ============================================  -->
    <!-- Target: svncheckout                           -->
    <!-- ============================================  -->
    <target name="svncheckout" description="checks out the required sources from SVN">
		<svncheckout
			svnpath="${svn.path}"
			force="true"
			nocache="true"
			ignoreexternals="false"
			repositoryurl="${svn.url}"
			todir="${buildDir}"
		/>
    </target>
    
    <!-- ============================================  -->
    <!-- Target: moveToDev                             -->
    <!-- ============================================  -->
    <target name="moveToDev" description="moves the sources to the live server">
    	<delete dir="/var/www/motivado-dev/next" failonerror="true" includeemptydirs="true"/>
    	<mkdir dir="/var/www/motivado-dev/next" />
    	<copy todir="/var/www/motivado-dev/next" >
    		<fileset refid="allfiles" />
    	</copy>
    </target>
    
    <!-- ============================================  -->
    <!-- Target: switchDev                             -->
    <!-- ============================================  -->
    <target name="switchDev" description="switches the current with the new sources">
    	<tstamp />
		<move file="/var/www/motivado-dev/current" tofile="/var/www/motivado-dev/old_${DSTAMP}_${TSTAMP}"/>
		<move file="/var/www/motivado-dev/next" tofile="/var/www/motivado-dev/current"/>
    </target>

    <!-- ============================================  -->
    <!-- Target: local                      		   -->
    <!-- ============================================  -->
    <target name="local" depends="svncheckout" description="adjust settings for local development">
        <copy file="${shop.local.xml.file}.local" tofile="${shop.local.xml.file}" />
        <copy file="${api.configuration.file}.local" tofile="${api.configuration.file}" />
        <echo>BUILD SUCCESS</echo>
    </target>
    
    <!-- ============================================  -->
    <!-- Target: dev                        		   -->
    <!-- ============================================  -->
    <target name="dev" description="adjust settings for development deployment">
    	<exec command="rm -rf `find . -name .svn`" dir="." />
        <copy file="${shop.local.xml.file}.dev" tofile="${shop.local.xml.file}" />
        <copy file="${api.configuration.file}.dev" tofile="${api.configuration.file}" />
        <phingcall target="moveToDev" />
        <phingcall target="switchDev" />
        <echo>BUILD SUCCESS</echo>
    </target>
    
    <!-- ============================================  -->
    <!-- Target: live                       		   -->
    <!-- ============================================  -->
    <target name="live" description="adjust settings for live deployment">
    	<exec command="rm -rf `find . -name .svn`" dir="." />
        <copy file="${shop.local.xml.file}" todir="shop/app/etc" />
        <copy file="${api.configuration.file}" todir="motivado-api" />
        <copy file="${importer.configuration.file}" todir="coaching-import" />
        <!--exec command="php coaching-import/cli/import.php" checkreturn="true" /-->
        <delete dir="coaching-import" includeemptydirs="true" failonerror="true" />
        <delete dir="modeling" includeemptydirs="true" failonerror="true" />
        <delete dir="build-scripts" includeemptydirs="true" failonerror="true" />
        <delete dir="configurations" includeemptydirs="true" failonerror="true" />
        <tar destfile="phing.tar" basedir="." compression="gzip"/>
        <scp username="${server.username}" 
        	 password="${server.password}"
        	 host="${server.host}" 
        	 todir="/home/john316"
        	 autocreate="true"
        	 file="phing.tar" />
        <ssh username="${server.username}" 
        	 password="${server.password}"
        	 host="${server.host}" 
        	 command="tar -C /home/john316 -xf phing.tar" />
        <!-- KILL SESSIONS -->
        <echo>BUILD SUCCESS</echo>
    </target>
    
</project>
